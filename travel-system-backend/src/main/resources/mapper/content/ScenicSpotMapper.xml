<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.smarttravel.content.mapper.ScenicSpotMapper">

    <resultMap id="ScenicSpotResult" type="com.smarttravel.content.domain.ScenicSpot">
        <id column="id" property="id"/>
        <result column="name" property="name"/>
        <result column="province" property="province"/>
        <result column="city" property="city"/>
        <result column="city_id" property="cityId"/>
        <result column="address" property="address"/>
        <result column="latitude" property="latitude"/>
        <result column="longitude" property="longitude"/>
        <result column="intro" property="intro"/>
        <result column="open_time" property="openTime"/>
        <result column="ticket_info" property="ticketInfo"/>
        <result column="price" property="price"/>
        <result column="image_url" property="imageUrl"/>
        <result column="is_world_heritage" property="isWorldHeritage"/>
        <result column="suggested_visit_time" property="suggestedVisitTime"/>
        <result column="score" property="score"/>
        <result column="hot_score" property="hotScore"/>
        <result column="is_recommend" property="isRecommend"/>
        <result column="create_time" property="createTime"/>
        <result column="update_time" property="updateTime"/>
        <result column="del_flag" property="delFlag"/>
    </resultMap>

    <select id="selectList" parameterType="com.smarttravel.content.domain.ScenicSpot" resultMap="ScenicSpotResult">
        SELECT id, name, province, city, city_id, address, latitude, longitude, intro, open_time, ticket_info,
               price, image_url, is_world_heritage, suggested_visit_time,
               score, hot_score, is_recommend, create_time, update_time, del_flag
        FROM scenic_spot
        WHERE del_flag = 0
        <if test="province != null and province != ''">
            AND province LIKE CONCAT('%', #{province}, '%')
        </if>
        <if test="city != null and city != ''">
            AND city LIKE CONCAT('%', #{city}, '%')
        </if>
        <if test="cityId != null">
            AND city_id = #{cityId}
        </if>
        <if test="isRecommend != null">
            AND is_recommend = #{isRecommend}
        </if>
        ORDER BY hot_score DESC, score DESC
    </select>

    <select id="selectListWithPage" resultMap="ScenicSpotResult">
        SELECT id, name, province, city, city_id, address, latitude, longitude, intro, open_time, ticket_info,
               price, image_url, is_world_heritage, suggested_visit_time,
               score, hot_score, is_recommend, create_time, update_time, del_flag
        FROM scenic_spot
        WHERE del_flag = 0
        <if test="query.province != null and query.province != ''">
            AND province LIKE CONCAT('%', #{query.province}, '%')
        </if>
        <if test="query.city != null and query.city != ''">
            AND city LIKE CONCAT('%', #{query.city}, '%')
        </if>
        <if test="query.cityId != null">
            AND city_id = #{query.cityId}
        </if>
        <if test="query.isRecommend != null">
            AND is_recommend = #{query.isRecommend}
        </if>
        <if test="query.name != null and query.name != ''">
            AND name LIKE CONCAT('%', #{query.name}, '%')
        </if>
        ORDER BY hot_score DESC, score DESC
        LIMIT #{offset}, #{pageSize}
    </select>

    <select id="countList" parameterType="com.smarttravel.content.domain.ScenicSpot" resultType="int">
        SELECT COUNT(*)
        FROM scenic_spot
        WHERE del_flag = 0
        <if test="province != null and province != ''">
            AND province LIKE CONCAT('%', #{province}, '%')
        </if>
        <if test="city != null and city != ''">
            AND city LIKE CONCAT('%', #{city}, '%')
        </if>
        <if test="cityId != null">
            AND city_id = #{cityId}
        </if>
        <if test="isRecommend != null">
            AND is_recommend = #{isRecommend}
        </if>
        <if test="name != null and name != ''">
            AND name LIKE CONCAT('%', #{name}, '%')
        </if>
    </select>

    <select id="selectById" parameterType="long" resultMap="ScenicSpotResult">
        SELECT id, name, province, city, city_id, address, latitude, longitude, intro, open_time, ticket_info,
               price, image_url, is_world_heritage, suggested_visit_time,
               score, hot_score, is_recommend, create_time, update_time, del_flag
        FROM scenic_spot
        WHERE id = #{id} AND del_flag = 0
    </select>

    <select id="selectHotByCityId" resultMap="ScenicSpotResult">
        SELECT id, name, province, city, city_id, address, latitude, longitude, intro, open_time, ticket_info,
               price, image_url, is_world_heritage, suggested_visit_time,
               score, hot_score, is_recommend, create_time, update_time, del_flag
        FROM scenic_spot
        WHERE del_flag = 0
        <if test="cityId != null">
            AND city_id = #{cityId}
        </if>
        ORDER BY hot_score DESC, score DESC
        LIMIT #{limit}
    </select>

    <select id="selectHotByProvince" resultMap="ScenicSpotResult">
        SELECT id, name, province, city, city_id, address, latitude, longitude, intro, open_time, ticket_info,
               price, image_url, is_world_heritage, suggested_visit_time,
               score, hot_score, is_recommend, create_time, update_time, del_flag
        FROM scenic_spot
        WHERE del_flag = 0
        <if test="province != null and province != ''">
            AND (
                province = #{province}
                OR province = CONCAT(#{province}, '市')
                OR province = CONCAT(#{province}, '省')
                OR province = CONCAT(#{province}, '自治区')
<<<<<<< HEAD
                OR province = CONCAT(#{province}, '特别行政区')
                OR province LIKE CONCAT(#{province}, '%')
                OR #{province} LIKE CONCAT(province, '%')
=======
                OR REPLACE(REPLACE(REPLACE(province, '市', ''), '省', ''), '自治区', '') = #{province}
                OR REPLACE(REPLACE(REPLACE(#{province}, '市', ''), '省', ''), '自治区', '') = REPLACE(REPLACE(REPLACE(province, '市', ''), '省', ''), '自治区', '')
>>>>>>> 299642f29c0d19bfedecf29490a18cfe2ad7de4f
            )
        </if>
        ORDER BY (hot_score * 2 + COALESCE(score, 0)) DESC
        LIMIT #{limit}
    </select>

    <select id="selectTopByTotalScore" resultMap="ScenicSpotResult">
        SELECT id, name, province, city, city_id, address, latitude, longitude, intro, open_time, ticket_info,
               price, image_url, is_world_heritage, suggested_visit_time,
               score, hot_score, is_recommend, create_time, update_time, del_flag
        FROM scenic_spot
        WHERE del_flag = 0
        ORDER BY (hot_score * 2 + COALESCE(score, 0)) DESC
        LIMIT #{limit}
    </select>

    <select id="selectRecommend" resultMap="ScenicSpotResult">
        SELECT id, name, province, city, city_id, address, latitude, longitude, intro, open_time, ticket_info,
               price, image_url, is_world_heritage, suggested_visit_time,
               score, hot_score, is_recommend, create_time, update_time, del_flag
        FROM scenic_spot
        WHERE del_flag = 0 AND is_recommend = 1
        ORDER BY hot_score DESC, score DESC
        LIMIT #{limit}
    </select>

    <insert id="insert" parameterType="com.smarttravel.content.domain.ScenicSpot" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO scenic_spot (name, province, city, city_id, address, latitude, longitude, intro, open_time, ticket_info,
               price, image_url, is_world_heritage, suggested_visit_time,
               score, hot_score, is_recommend, create_time, update_time, del_flag)
        VALUES (#{name}, #{province}, #{city}, #{cityId}, #{address}, #{latitude}, #{longitude}, #{intro}, #{openTime}, #{ticketInfo},
               #{price}, #{imageUrl}, #{isWorldHeritage}, #{suggestedVisitTime},
               #{score}, #{hotScore}, #{isRecommend}, NOW(), NOW(), 0)
    </insert>

    <update id="update" parameterType="com.smarttravel.content.domain.ScenicSpot">
        UPDATE scenic_spot
        <set>
            <if test="name != null">name = #{name},</if>
            <if test="province != null">province = #{province},</if>
            <if test="city != null">city = #{city},</if>
            <if test="cityId != null">city_id = #{cityId},</if>
            <if test="address != null">address = #{address},</if>
            <if test="latitude != null">latitude = #{latitude},</if>
            <if test="longitude != null">longitude = #{longitude},</if>
            <if test="intro != null">intro = #{intro},</if>
            <if test="openTime != null">open_time = #{openTime},</if>
            <if test="ticketInfo != null">ticket_info = #{ticketInfo},</if>
            <if test="price != null">price = #{price},</if>
            <if test="imageUrl != null">image_url = #{imageUrl},</if>
            <if test="isWorldHeritage != null">is_world_heritage = #{isWorldHeritage},</if>
            <if test="suggestedVisitTime != null">suggested_visit_time = #{suggestedVisitTime},</if>
            <if test="score != null">score = #{score},</if>
            <if test="hotScore != null">hot_score = #{hotScore},</if>
            <if test="isRecommend != null">is_recommend = #{isRecommend},</if>
            <if test="delFlag != null">del_flag = #{delFlag},</if>
            update_time = NOW()
        </set>
        WHERE id = #{id}
    </update>

    <update id="incrementHotScore">
        UPDATE scenic_spot
        SET hot_score = COALESCE(hot_score, 0) + #{increment},
            update_time = NOW()
        WHERE id = #{id} AND del_flag = 0
    </update>

    <select id="selectByIdWithoutDelFlag" parameterType="long" resultMap="ScenicSpotResult">
        SELECT id, name, province, city, city_id, address, latitude, longitude, intro, open_time, ticket_info,
               price, image_url, is_world_heritage, suggested_visit_time,
               score, hot_score, is_recommend, create_time, update_time, del_flag
        FROM scenic_spot
        WHERE id = #{id}
    </select>

    <delete id="deleteByIdPhysically" parameterType="long">
        DELETE FROM scenic_spot
        WHERE id = #{id}
    </delete>
</mapper>












